---
- hosts: webservers
  user: vagrant
  sudo: yes
  gather_facts: no
  vars:
    app_name: portfolio
  roles:
    - core
    - db
    - nginx

- hosts: webservers
  sudo: yes
  user: vagrant
  sudo_user: postgres
  gather_facts: no
  vars:
    dbname: myapp
    dbuser: vagrant
    dbpassword: vagrant

  tasks:
  - name: ensure database is created
    action: postgresql_db db={{dbname}}

  - name: ensure user has access to database
    action: postgresql_user db={{dbname}} user={{dbuser}} password={{dbpassword}} priv=ALL

  - name: ensure user does not have unnecessary privilege
    action: postgresql_user user={{dbuser}} role_attr_flags=NOSUPERUSER,NOCREATEDB